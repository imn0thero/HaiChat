<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <title>HaiChat</title>
</head>
<body>
  <h2 id="welcome"></h2>
  <button id="logoutBtn">Logout</button>

  <div>
    <h3>Pengguna Online:</h3>
    <div id="onlineUsers"></div>
  </div>

  <div id="chatbox"></div>

  <div id="inputArea">
    <input id="msgInput" placeholder="Tulis pesan..." autocomplete="off" />
    <input type="file" id="mediaInput" />
    <button id="sendBtn">Kirim</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const username = localStorage.getItem('username');
    const password = localStorage.getItem('password');

    if (!username || !password) {
      window.location.href = 'login.html';
    }

    document.getElementById('welcome').innerText = "Hai, " + username;

    const socket = io();

    socket.emit('login', { username, password });

    socket.on('loginResult', res => {
      if (!res.success) {
        alert('Login gagal, silakan login ulang');
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        window.location.href = 'login.html';
      }
    });

    socket.on('loadMessages', data => {
      data.forEach(message => showMessage(message));
      scrollToBottom();
    });

    socket.on('message', data => {
      showMessage(data);
      scrollToBottom();
    });

    socket.on('userList', users => {
      const userList = users.map(user => `<li>${user} ðŸ”µ</li>`).join('');
      document.getElementById('onlineUsers').innerHTML = "<ul>" + userList + "</ul>";
    });

    function showMessage(data) {
      const chatbox = document.getElementById('chatbox');
      const div = document.createElement('div');
      div.classList.add('message');
      if (data.user === username) {
        div.classList.add('message-right');
      } else {
        div.classList.add('message-left');
      }

      if (data.text.startsWith('uploads/')) {
        div.innerHTML = `<strong>${data.user}</strong><br>
          <img src="${data.text}" alt="media" style="max-width:100%; max-height:200px; border-radius:6px;" />`;
      } else {
        div.innerHTML = `<strong>${data.user}</strong><br>${escapeHtml(data.text)}`;
      }
      chatbox.appendChild(div);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.innerText = text;
      return div.innerHTML;
    }

    function scrollToBottom() {
      const chatbox = document.getElementById('chatbox');
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    document.getElementById('sendBtn').onclick = () => {
      const textInput = document.getElementById('msgInput');
      const mediaInput = document.getElementById('mediaInput');

      if (mediaInput.files.length > 0) {
        // Upload media
        const file = mediaInput.files[0];
        const formData = new FormData();
        formData.append('media', file);

        fetch('/upload', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              socket.emit('message', { text: data.path });
              mediaInput.value = '';
            } else {
              alert('Gagal mengirim media');
            }
          });
      } else if (textInput.value.trim() !== '') {
        socket.emit('message', { text: textInput.value.trim() });
        textInput.value = '';
      }
    };

    document.getElementById('logoutBtn').onclick = () => {
      socket.emit('logout');
      localStorage.removeItem('username');
      localStorage.removeItem('password');
      window.location.href = 'login.html';
    };
  </script>
</body>
</html>
